<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SketchBug Study</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #f9f9f9;
      margin: 0;
    }

    h1 {
      margin-bottom: 40px;
    }

    .participant-form {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
      text-align: center;
      min-width: 400px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }

    input[type="text"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      box-sizing: border-box;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #007BFF;
    }

    select {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      box-sizing: border-box;
      background-color: white;
    }

    select:focus {
      outline: none;
      border-color: #007BFF;
    }

    .btn {
      background-color: #007BFF;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.2s;
    }

    .btn:hover {
      background-color: #0056b3;
    }

    .btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .study-links {
      display: none;
    }

    .study-links.show {
      display: block;
    }

    ul {
      list-style: none;
      padding: 0;
    }

    li {
      margin: 15px 0;
      list-style: none;
    }

    a {
      text-decoration: none;
      color: #007BFF;
      font-size: 18px;
      transition: all 0.2s ease;
      display: inline-block;
      padding: 10px 16px;
      border-radius: 6px;
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
      min-width: 280px;
      text-align: left;
    }

    a:hover {
      color: #0056b3;
      background-color: #e7f3ff;
      border-color: #007BFF;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
    }

    .participant-info {
      background: #e8f5e8;
      border: 1px solid #4caf50;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      text-align: center;
    }

    .change-id {
      background: none;
      border: none;
      color: #007BFF;
      cursor: pointer;
      text-decoration: underline;
      font-size: 14px;
    }


  </style>
</head>
<body>

  <h1>Welcome to the SketchBug Study</h1>

  <!-- Participant ID Form -->
  <div id="participantForm" class="participant-form">
    <!-- <h2>Please Enter Your Participant ID</h2> -->
    <div class="form-group">
      <!-- <label for="participantId">Participant ID:</label> -->
      <input type="text" id="participantId" placeholder="Enter your participant ID" required>
    </div>
    
    <div class="form-group">
      <label for="experimentCondition">Experiment Condition:</label>
      <select id="experimentCondition" required>
        <option value="">Select condition...</option>
        <option value="condition1">Condition 1: Sketch+Task1, Keyboard+Task2</option>
        <option value="condition2">Condition 2: Keyboard+Task2, Sketch+Task1</option>
        <option value="condition3">Condition 3: Sketch+Task2, Keyboard+Task1</option>
        <option value="condition4">Condition 4: Keyboard+Task1, Sketch+Task2</option>
      </select>
    </div>
    
    <button class="btn" onclick="setParticipantId()">Continue</button>
  </div>

  <!-- Study Links (hidden initially) -->
  <div id="studyLinks" class="study-links">
    <div class="participant-info">
      <strong>Participant ID:</strong> <span id="displayParticipantId"></span><br>
      <strong>Condition:</strong> <span id="displayCondition"></span>
      <button class="change-id" onclick="changeParticipantId()">Change ID</button>
    </div>

    <ul id="taskList">
      <!-- Task links will be dynamically generated based on condition -->
    </ul>
  </div>

  <script>
    // Check if participant ID is already stored
    document.addEventListener('DOMContentLoaded', function() {
      const storedId = localStorage.getItem('participant_id');
      const storedCondition = localStorage.getItem('experiment_condition');
      if (storedId && storedCondition) {
        showStudyLinks(storedId, storedCondition);
      }
    });

    function setParticipantId() {
      const participantId = document.getElementById('participantId').value.trim();
      const experimentCondition = document.getElementById('experimentCondition').value;
      
      if (!participantId) {
        alert('Please enter a participant ID');
        return;
      }

      if (!experimentCondition) {
        alert('Please select an experiment condition');
        return;
      }

      // Clear ALL previous participant data to ensure clean slate
      clearAllParticipantData();

      // Store new participant ID and experiment condition in localStorage
      localStorage.setItem('participant_id', participantId);
      localStorage.setItem('experiment_condition', experimentCondition);
      localStorage.setItem('participant_start_time', new Date().toISOString());
      
      console.log('New participant session started:', participantId);
      console.log('Experiment condition:', experimentCondition);
      console.log('All previous data cleared for clean session');
      showStudyLinks(participantId, experimentCondition);
    }

    function clearAllParticipantData() {
      // List of all possible data keys to clear
      const dataKeys = [
        // Participant info
        'participant_id',
        'participant_start_time',
        'experiment_condition',
        
        // Task data
        'stepover_stop_task1_start_time',
        'stepover_stop_task1_end_time',
        'stepover_stop_task1_duration_seconds',
        'stepover_stop_task1_rating',
        
        'breakpoint_start_task_start_time',
        'breakpoint_start_task_end_time',
        'breakpoint_start_task_duration_seconds',
        'breakpoint_start_task_rating',
        
        'continue_task_start_time',
        'continue_task_end_time',
        'continue_task_duration_seconds',
        'continue_task_rating',
        
        'stepinto_task_start_time',
        'stepinto_task_end_time',
        'stepinto_task_duration_seconds',
        'stepinto_task_rating',
        
        'stepout_task_start_time',
        'stepout_task_end_time',
        'stepout_task_duration_seconds',
        'stepout_task_rating',
        
        'task1_start_time',
        'task1_end_time',
        'task1_duration_seconds',
        'task1_rating',
        
        'breakpoint_start_task2_start_time',
        'breakpoint_start_task2_end_time',
        'breakpoint_start_task2_duration_seconds',
        'breakpoint_start_task2_rating',
        
        'continue_task2_start_time',
        'continue_task2_end_time',
        'continue_task2_duration_seconds',
        'continue_task2_rating',
        
        'stepinto_task2_start_time',
        'stepinto_task2_end_time',
        'stepinto_task2_duration_seconds',
        'stepinto_task2_rating',
        
        'stepout_task2_start_time',
        'stepout_task2_end_time',
        'stepout_task2_duration_seconds',
        'stepout_task2_rating',
        
        'stepover_stop_task2_start_time',
        'stepover_stop_task2_end_time',
        'stepover_stop_task2_duration_seconds',
        'stepover_stop_task2_rating',
        
        'task2_start_time',
        'task2_end_time',
        'task2_duration_seconds',
        'task2_rating',

        'task3_start_time',
        'task3_end_time',
        'task3_duration_seconds',
        'task3_rating'
      ];

      // Clear all participant data
      dataKeys.forEach(key => {
        localStorage.removeItem(key);
      });

      console.log('Cleared all participant data keys:', dataKeys.length, 'items');
    }

    function showStudyLinks(participantId, experimentCondition) {
      document.getElementById('participantForm').style.display = 'none';
      document.getElementById('studyLinks').classList.add('show');
      document.getElementById('displayParticipantId').textContent = participantId;
      document.getElementById('displayCondition').textContent = getConditionDescription(experimentCondition);
      
      generateTaskList(experimentCondition);
    }

    function getConditionDescription(condition) {
      const descriptions = {
        'condition1': 'Sketch+Task1, Keyboard+Task2',
        'condition2': 'Keyboard+Task2, Sketch+Task1', 
        'condition3': 'Sketch+Task2, Keyboard+Task1',
        'condition4': 'Keyboard+Task1, Sketch+Task2'
      };
      return descriptions[condition] || condition;
    }

    function generateTaskList(experimentCondition) {
      const taskList = document.getElementById('taskList');
      taskList.innerHTML = '';

      // Common tasks that appear in all conditions
      const commonTasks = [
        '<li><a href="https://uwaterloo.ca1.qualtrics.com/jfe/form/SV_emOP8hXwSR2lF2e" target="_blank">ðŸ“‹ Pre-Questionnaire</a></li>'
      ];

      // Condition-specific task sequences
      const conditionTasks = {
        'condition1': [
          // Sketch + Task 1, then Keyboard + Task 2
          '<li><a href="tutorial_sketch_break_start.html" target="_blank">ðŸ“– Tutorial: Sketch Mode</a></li>',
          '<li><a href="task1.html" target="_blank">ðŸ§© Task 1 (Sketch Mode)</a></li>',
          '<li><a href="tutorial_keyboard_break_start.html" target="_blank">ðŸ“– Tutorial: Keyboard Mode</a></li>',
          '<li><a href="task2.html" target="_blank">ðŸ§© Task 2 (Keyboard Mode)</a></li>'
        ],
        'condition2': [
          // Keyboard + Task 2, then Sketch + Task 1  
          '<li><a href="tutorial_keyboard_break_start.html" target="_blank">ðŸ“– Tutorial: Keyboard Mode</a></li>',
          '<li><a href="task2.html" target="_blank">ðŸ§© Task 2 (Keyboard Mode)</a></li>',
          '<li><a href="tutorial_sketch_break_start.html" target="_blank">ðŸ“– Tutorial: Sketch Mode</a></li>',
          '<li><a href="task1.html" target="_blank">ðŸ§© Task 1 (Sketch Mode)</a></li>'
        ],
        'condition3': [
          // Sketch + Task 2, then Keyboard + Task 1
          '<li><a href="tutorial_sketch_break_start.html" target="_blank">ðŸ“– Tutorial: Sketch Mode</a></li>',
          '<li><a href="task2.html" target="_blank">ðŸ§© Task 2 (Sketch Mode)</a></li>',
          '<li><a href="tutorial_keyboard_break_start.html" target="_blank">ðŸ“– Tutorial: Keyboard Mode</a></li>',
          '<li><a href="task1.html" target="_blank">ðŸ§© Task 1 (Keyboard Mode)</a></li>'
        ],
        'condition4': [
          // Keyboard + Task 1, then Sketch + Task 2
          '<li><a href="tutorial_keyboard_break_start.html" target="_blank">ðŸ“– Tutorial: Keyboard Mode</a></li>',
          '<li><a href="task1.html" target="_blank">ðŸ§© Task 1 (Keyboard Mode)</a></li>',
          '<li><a href="tutorial_sketch_break_start.html" target="_blank">ðŸ“– Tutorial: Sketch Mode</a></li>',
          '<li><a href="task2.html" target="_blank">ðŸ§© Task 2 (Sketch Mode)</a></li>'
        ]
      };

      // Final tasks
      const finalTasks = [
        '<li><a href="#" onclick="downloadCSV(); return false;">ðŸ“¥ Download CSV</a></li>',
        '<li><a href="https://uwaterloo.ca1.qualtrics.com/jfe/form/SV_0AMYWoJCsaoDoO2" target="_blank">ðŸ“‹ Post-Questionnaire</a></li>',
        '<li><a href="task3.html" target="_blank">ðŸ§© Task 3 (Combined Mode)</a></li>'
      ];

      // Combine all tasks
      const allTasks = [
        ...commonTasks,
        ...(conditionTasks[experimentCondition] || []),
        ...finalTasks
      ];

      taskList.innerHTML = allTasks.join('');
    }

    function changeParticipantId() {
      const currentId = localStorage.getItem('participant_id');
      const hasData = checkIfHasAnyData();
      
      let confirmMessage = 'Are you sure you want to change the participant ID?';
      if (hasData) {
        confirmMessage += '\n\nâš ï¸ WARNING: This will clear ALL existing study data for the current participant (' + currentId + ').\n\nThis action cannot be undone!';
      }
      
      if (confirm(confirmMessage)) {
        document.getElementById('participantForm').style.display = 'block';
        document.getElementById('studyLinks').classList.remove('show');
        document.getElementById('participantId').value = '';
        document.getElementById('participantId').focus();
        
        if (hasData) {
          console.log('User confirmed changing participant ID - data will be cleared when new ID is set');
        }
      }
    }

    function checkIfHasAnyData() {
      // Check if any task data exists
      const taskKeys = [
        'task1_start_time', 'task2_start_time', 'task3_start_time',
        'stepover_stop_task1_start_time', 'breakpoint_start_task_start_time',
        'continue_task_start_time', 'stepinto_task_start_time',
        'stepout_task_start_time'
      ];
      
      return taskKeys.some(key => localStorage.getItem(key) !== null);
    }

    function downloadCSV() {
      const participantId = localStorage.getItem('participant_id') || 'Unknown';
      
      if (!participantId || participantId === 'Unknown') {
        alert('Please set a participant ID first!');
        return;
      }

      console.log(`ðŸ“¥ Downloading CSV for participant: ${participantId}`);
      console.log(`ðŸ”’ Data isolation verified - CSV contains ONLY data for participant: ${participantId}`);

      // Collect all data
      const data = getAllTaskData();
      
      if (data.length === 0) {
        alert('No task data found to download. Please complete some tasks first.');
        return;
      }

      // Generate CSV content
      const headers = [
        'Participant ID',
        'Experiment Condition',
        'Participant Start Time',
        'Task Name',
        'Start Time',
        'End Time', 
        'Duration (seconds)',
        'Duration (minutes)',
        'Success Rating'
      ];

      let csvContent = headers.join(',') + '\n';
      
      data.forEach(row => {
        csvContent += row.join(',') + '\n';
      });

      // Create and download file
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      
      const now = new Date();
      const dateStr = now.toISOString().split('T')[0]; // YYYY-MM-DD
      const filename = `study_results_${participantId}_${dateStr}.csv`;
      
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      console.log(`âœ… CSV downloaded: ${filename}`);
      alert(`âœ… CSV file downloaded successfully!\nFile: ${filename}`);
    }

    function getAllTaskData() {
      const participantId = localStorage.getItem('participant_id') || 'Unknown';
      const experimentCondition = localStorage.getItem('experiment_condition') || 'Unknown';
      const participantStartTime = localStorage.getItem('participant_start_time') || '';
      const data = [];

      // Define all possible tasks
      const tasks = [
        'stepover_stop_task1',
        'breakpoint_start_task', 
        'continue_task',
        'stepinto_task',
        'stepout_task',
        'task1',
        'breakpoint_start_task2',
        'continue_task2', 
        'stepinto_task2',
        'stepout_task2',
        'stepover_stop_task2',
        'task2',
        'task3'
      ];

      tasks.forEach(taskName => {
        const startTime = localStorage.getItem(`${taskName}_start_time`);
        const endTime = localStorage.getItem(`${taskName}_end_time`);
        const durationSeconds = localStorage.getItem(`${taskName}_duration_seconds`);
        const rating = localStorage.getItem(`${taskName}_rating`);

        if (startTime || endTime || durationSeconds || rating) {
          const durationMinutes = durationSeconds ? Math.round(parseFloat(durationSeconds) / 60 * 100) / 100 : '';
          
          data.push([
            participantId,
            experimentCondition,
            participantStartTime,
            taskName,
            startTime || '',
            endTime || '',
            durationSeconds || '',
            durationMinutes || '',
            rating || ''
          ]);
        }
      });

      return data;
    }
  </script>

</body>
</html>
